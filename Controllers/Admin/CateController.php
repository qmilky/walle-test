<?php    /*类别控制器*/namespace Admin;use DB;    class CateController extends CommonController    {        // 添加类别        public function add()        {            // 由添加子分类传递过来            $cid = empty($_GET['cid']) ? 0 : $_GET['cid'];            // 获取之前已有的类别信息            // $sql = "select * from shop_cate order by concat(path,cid,',')";            $cates = (new DB('shop_cate')) -> orderBy(" concat(path,cid,',') ")                                            -> select();                        // 显示到页面            include('./Views/Admin/Cate/insert.html');        }                public function doadd()        {           $data['cname'] = $_POST['cname'];           $pid = $data['pid'] = $_POST['pid'];                      $db = new DB('shop_cate');                      // 如果新类别的 pid 为 0           if ($pid === '0') {               $data['path'] = '0,';           } else {               $cateInfo = $db -> where("cid=$pid") -> find();               $data['path'] = $cateInfo->path.$pid.',';           }                      // 执行插入           $row = $db -> insert($data);                      if ($row) {               echo '添加类别成功';           } else {               echo '添加类别失败';           }           header('refresh:2;url=./index.php?m=admin&c=cate&a=add');           die;        }                // 浏览类别        public function index()        {                        // 获取类别信息            $cates = (new DB('shop_cate')) -> orderBy(" concat(path,cid,',') ") -> select();                        // 显示到页面            include('./Views/Admin/Cate/catelist.html');        }                static public function getCates()        {            // 1.得到类别数组            $cates = (new DB('shop_cate'))->select();                                   // 2.生成层级关系数组            return self::getLevelCate($cates, 0);                        // echo '<pre>';            // print_r($cates);            // echo '</pre>';            // die;                        // 2.写一个函数            // return ($a = function($cates, $pid=0)use(&$a){                    // $sub = [];                    // foreach($cates as $k=>$v){                        // if ($v->pid==$pid){                            // $v->sub = $a($cates, $v->cid);                            // $sub[] = $v;                        // }                    // }                    // return $sub;            // })($cates,0);                                }                        // 删除类别        public function del()        {            $cid = $_GET['cid']; // 要删除类别的编号            $db = new DB('shop_cate');                        // 1.获取要删除的类别下的子类个数            $subcnt = $db->where("pid=$cid")->rowCount();            $db->clearWhere();  // 手工清除查询条件                        // 2.判断是否存在子类            if ($subcnt) {                header('refresh:2;url=./index.php?m=admin&c=cate&a=index');                die('要删除的类别下面存在子类,不能删除!!!');            }                        // 判断是否存在商品                        // 执行删除            $row = $db->where(" cid={$cid} ")->delete();                        if ($row) {               echo '<br>删除类别成功';           } else {               echo '删除类别失败';           }           header('refresh:2;url=./index.php?m=admin&c=cate&a=index');           die;                    }                // 修改类别        public function edit()        {            $cid = $_GET['cid'];            $cate = (new DB('shop_cate')) -> where("cid=$cid")->find();                        // 显示到页面            include('./Views/Admin/Cate/editcate.html');        }                public function doedit()        {            $cid = $_GET['cid'];            $data['cname'] = $_POST['cname'];                        $row = (new DB('shop_cate')) -> where("cid=$cid") -> update($data);                        if ($row) {                echo '修改成功';                header('refresh:2;url=./index.php?m=admin&c=cate&a=index');                die;            } else {                echo '修改失败';                header('refresh:2;url=./index.php?m=admin&c=cate&a=edit&cid='.$cid);                die;            }                                }                // 查pid为0的子类, 返回子类数组        static public function getLevelCate($cates, $pid=0)        {            $sub = [];            foreach($cates as $k=>$v){                if ($v->pid==$pid){                    $v->sub = self::getLevelCate($cates, $v->cid);                    $sub[] = $v;                }            }            return $sub;        }            }