<?php    // 订单控制器namespace Home;use DB;use PDO;    class OrderController    {        private $oid; // 订单号                // 获取收货信息        public function getinfo()        {                       // 判断是否登录,如果没有登录就跳转到登录             if (empty($_SESSION['homeFlag'])) {                $_SESSION['back'] = $_SERVER['REQUEST_URI'];                header('refresh:2;url=./index.php?m=home&c=user&a=login');                die('您还没有登录...请跳转到登录...');            }                        include('./Views/Home/Order/getinfo.html');        }                // 最后结算页        public function jsy()        {            $_SESSION['order']['rec'] = $_POST['rec'];            $_SESSION['order']['tel'] = $_POST['tel'];            $_SESSION['order']['addr'] = $_POST['addr'];            $_SESSION['order']['umsg'] = $_POST['umsg'];            $_SESSION['order']['uid'] = $_SESSION['userInfo']->uid;                        include('./Views/Home/Order/jsy.html');        }                // 生成订单        public function finish()        {            // 开启事务            DB::getPDO() -> beginTransaction();                        // 修改库存            if ($this->updateStock() && $this -> writeOrder() && $this -> writeDetail()){                           // 确认提交               DB::getPDO()-> commit();                              // 清购物车               $this -> clearCart();                           } else {                            // 撤销,回退                DB::getPDO()-> rollBack();                echo '提交订单失败';                die;                header('refresh:2;url=./index.php?m=home&c=cart&a=index');                die;            }        }                // 修改库存和销量        public function updateStock()        {            $sql = "update shop_goods set stock=stock-:cnt,salecnt=salecnt+:cnt where gid=:gid";                        // 准备执行, 返回预处理对象            $stmt = DB::getPDO() -> prepare($sql);  // 预处理                        foreach($_SESSION['cart'] as $k=>$v){                // 具体的,实际的,执行                $stmt -> execute([':cnt'=>$v->bcnt, ':gid'=>$k]);                                // 返回上一条SQL语句的受影响行数                $row = $stmt->rowCount();                                if (!$row) {                    echo '修改库存失败';                    return false;                }            }            return true;        }                        // 写入主表信息        public function writeOrder()        {                        $data['oid'] = $this->oid = date('YmdHis').mt_rand(1000,9999);            $data['ormb'] = $_SESSION['order']['ormb'];            $data['ocnt'] = $_SESSION['order']['ocnt'];            $data['uid'] = $_SESSION['userInfo']->uid;            $data['rec'] = $_SESSION['order']['rec'];            $data['addr'] = $_SESSION['order']['addr'];            $data['tel'] = $_SESSION['order']['tel'];            $data['status'] = 1;            $data['umsg'] = $_SESSION['order']['umsg'];            $data['otime'] = time();                        $flag = (new DB('shop_orders'))->insert($data);                        if (!$flag){                echo '写入主表失败';            }                        return $flag;                    }                        // 写入详情表        public function writeDetail()        {            /*            $sql = "insert into shop_detail(字段列表) values(值)";            $sql = "insert into shop_detail(字段列表) values(值)";            $sql = "insert into shop_detail(字段列表) values(值)";                                    $sql = "insert into shop_detail(字段列表) values(值1),(值2),(值3),";            */                    // 拼接sql语句          $sql = 'insert into shop_detail(oid,gid,bprice,bcnt) values';          foreach($_SESSION['cart'] as $k=>$v){                $sql .= "('{$this->oid}',{$v->gid},{$v->price},{$v->bcnt}),";          }          $sql = rtrim($sql,',');                    $flag = DB::getPDO() -> exec($sql);                    if (!$flag){             echo '写入详情表失败';          }                    return $flag;                   }                    // 清空购物车        public function clearCart()        {             header('refresh:2;url=./index.php?m=home&c=first&a=first');             include('./Views/Home/Order/finish.html');             unset($_SESSION['cart']);    // 清购物车             unset($_SESSION['order']);   // 清订单信息                          die;        }                /*        // 我的订单-版本二        public function myorder()        {            // 如果没有登录,跳转到登录            if (empty($_SESSION['homeFlag'])) {                $_SESSION['back'] = $_SERVER['REQUEST_URI'];                header('refresh:2;url=./index.php?m=home&c=user&a=login');                die('您还未登录, 请先登录...3秒后跳转');            }                        // 拿数据            $uid = $_SESSION['userInfo']->uid;                        $sql = "                  SELECT                     o.*,d.*,g.gname,g.gpic                  FROM                    shop_orders o LEFT JOIN shop_detail d  ON o.oid=d.oid                                  LEFT JOIN shop_goods  g  ON d.gid=g.gid                  WHERE                    o.uid='$uid'            ";                        $orders = (new DB('shop_orders'))->pdo->query($sql)->fetchAll(PDO::FETCH_CLASS);                        $ord = [];            foreach($orders as $k=>$v){                $ord[$v->oid]['ormb'] = $v->ormb;                $ord[$v->oid]['ocnt'] = $v->ocnt;                $ord[$v->oid]['addr'] = $v->addr;                $ord[$v->oid]['tel']     = $v->tel;                $ord[$v->oid]['rec']     = $v->rec;                $ord[$v->oid]['otime']   = $v->otime;                $ord[$v->oid]['status']  = $v->status;                                $goods = [];                $goods['gname'] = $v->gname;                $goods['gpic']  = $v->gpic;                $goods['bprice']= $v->bprice;                $goods['bcnt']  = $v->bcnt;                                $ord[$v->oid]['detail'][]  = $goods;                // 订单号                // 订单金额                // 订单数量                // 收货地址                // 联系电话                // 收货人                // 下单时间                // 订单状态                       // 商品名称                       // 商品图片                       // 成交价格                       // 购买数量            }                        echo '<pre>';            print_r($ord);                        die;                    // 引入浏览订单模板            include('./Views/Home/Order/myorder.html');                }        */                        // 我的订单  版本三        public function myorder()        {            // 如果没有登录,跳转到登录            if (empty($_SESSION['homeFlag'])) {                $_SESSION['back'] = $_SERVER['REQUEST_URI'];                header('refresh:2;url=./index.php?m=home&c=user&a=login');                die('您还未登录, 请先登录...3秒后跳转');            }                        // 拿数据            $uid = $_SESSION['userInfo']->uid;                        // 1.查这个用户的所有订单            $db_order = new DB('shop_orders');            $orders = $db_order->where("uid=$uid")->select();                        // 2.拿到所有详情            $db_detail = new DB('shop_detail');            $db_goods = new DB('shop_goods');            // error_reporting(E_ALL & ~E_NOTICE);            foreach($orders as $k=>$v){                // 1)尽量不要在循环内创建对象                // 2)尽量不要在循环内查询数据库, 等数据库返回的时间很长                $v->detail = $db_detail->where("oid='{$v->oid}'")->select();                foreach($v->detail as $kk=>$vv){                                        $goods = $db_goods->where("gid={$vv->gid}")->select();                    $vv->gname = $goods[0]->gname;                    $vv->gpic  = $goods[0]->gpic;                                        echo '<pre>';                    print_r($vv);                    // print_r($goods);                    echo '</pre>';                }                        }                        echo '<pre>';            print_r($orders);                            // 引入浏览订单模板            include('./Views/Home/Order/myorder.html');        }                                /*        // 我的订单 版本一        public function myorder()        {            // 如果没有登录,跳转到登录            if (empty($_SESSION['homeFlag'])) {                $_SESSION['back'] = $_SERVER['REQUEST_URI'];                header('refresh:2;url=./index.php?m=home&c=user&a=login');                die('您还未登录, 请先登录...3秒后跳转');            }                        // 拿数据            $uid = $_SESSION['userInfo']->uid;                    // $orders  某用户所有订单            $orders = (new DB('shop_orders'))->where("uid=$uid")->select();            $oid_arr = array_column($orders, 'oid');                 $orders = array_combine($oid_arr, $orders);  // 订单数组   [ 订单号 => 订单信息 ]                                // $details 所有订单的详情            $oid_in  = '\''.implode("','", $oid_arr).'\'';            $details = (new DB('shop_detail')) -> where("oid in($oid_in)") -> select();                    // oid in (  ' a ',' b ',' c ',' d ' )                    // $goods   所有详情中的商品            $gid_arr = array_column($details, 'gid');   // 商品ID数组            $gid_arr = array_unique($gid_arr);          // 去重            $gid_in  = implode(',', $gid_arr);          // 商品ID范围            $goods = (new DB('shop_goods')) -> where("gid in($gid_in)") -> select();            $goods = array_combine($gid_arr, $goods);   // 商品数组   [ 商品ID => 商品信息 ]                                // 将三个数组拼装            foreach($details as $k=>$v){                $v->gname = $goods[$v->gid] -> gname;  // 拿商品名称                $v->gpic  = $goods[$v->gid] -> gpic;   // 拿商品图片                                $orders[$v->oid] -> sub[] = $v;            }                                        // 引入浏览订单模板            include('./Views/Home/Order/myorder.html');                   }        */            }